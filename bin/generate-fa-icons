#!/usr/bin/env ruby
require 'json'

INPUT = 'config/font_awesome.json'.freeze
OUTPUT = 'app/javascript/src/font_awesome.js'.freeze

MODULE_MAP = {
  thin:    '@fortawesome/pro-thin-svg-icons',
  light:   '@fortawesome/pro-light-svg-icons',
  regular: '@fortawesome/pro-regular-svg-icons',
  solid:   '@fortawesome/pro-solid-svg-icons',
  duotone: '@fortawesome/pro-duotone-svg-icons',
  brands:  '@fortawesome/free-brands-svg-icons'
}.freeze

# do not edit below this line unless you're updating the script itself

banner = <<~EOS
  // THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.

  import { config, library, dom } from '@fortawesome/fontawesome-svg-core'

  // Fix flicker with Turbolinks (https://fontawesome.com/how-to-use/on-the-web/using-with/turbolinks)
  config.mutateApproach = 'sync'

EOS

config = JSON.parse(File.read(INPUT))              # => {"faUser" => ["light", "regular"]}
config = config.flat_map { |a, b| [a].product(b) } # => [["faUser", "light"], ["faUser", "regular"]]
config = config.map do |export, module_name|
  OpenStruct.new(
    export: export,
    module: MODULE_MAP.fetch(module_name.downcase.to_sym, module_name),
    alias: "#{export}#{module_name.capitalize}"
  )
end

File.open(OUTPUT, 'w') do |f|
  f.write(banner)

  config.each do |import|
    f.write "import { #{import.export} as #{import.alias} } from '#{import.module}/#{import.export}'\n"
  end

  f.write "\n"
  f.write "library.add(\n"
  f.write "  #{config.map(&:alias).join(",\n  ")}"
  f.write "\n);\n\n"

  f.write "dom.watch();"
end
